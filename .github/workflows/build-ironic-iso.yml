name: Build Ironic ISO

on:
  push:
    branches: [ master ]
    tags: [ "v*", "release-*" ]
  pull_request:
    branches: [ master ]
  workflow_dispatch: {}

jobs:
  build-ironic-iso:
    runs-on: ubuntu-latest
    container:
      image: quay.io/centos/centos:stream9

    env:
      BASE_DISTRO: centos
      DIB_RELEASE: "9-stream"
      IMAGE_NAME: ironic-centos9-ipa
      ARTIFACTS_DIR: artifacts

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Python and toolchain
        run: |
          dnf -y install sudo python3 python3-pip python3-devel gcc make libffi-devel openssl-devel

      - name: Install system dependencies (CentOS 9)
        run: |
          dnf -y install \
            qemu-img \
            kpartx \
            squashfs-tools \
            xorriso \
            mtools \
            dosfstools \
            shim-x64 \
            grub2-efi-x64

      - name: Upgrade pip and install Python packages
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install \
            diskimage-builder \
            ironic-python-agent-builder

      - name: Show versions
        run: |
          python3 --version
          python3 -m pip show diskimage-builder || true
          python3 -m pip show ironic-python-agent-builder || true

      - name: Build Ironic ISO (Secure Boot via shim)
        env:
          UEFI_METHOD: shim
          DIB_NO_TMPFS: 1
        run: |
          chmod +x scripts/build_ironic_iso.sh
          bash scripts/build_ironic_iso.sh

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: ironic-centos9-iso
          path: |
            artifacts/*.iso
            artifacts/*.kernel
            artifacts/*.initramfs
            artifacts/*.img
          retention-days: 3

      - name: Upload logs and build outputs (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-and-outputs
          path: |
            ipa-build/**
            iso-work/**
            artifacts/**
          if-no-files-found: ignore

  publish-release:
    name: Publish GitHub Release
    needs: build-ironic-iso
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: ironic-centos9-iso
          path: dist

      - name: Create GitHub Release and upload ISO
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.iso
            dist/*.kernel
            dist/*.initramfs
            dist/*.img
          draft: false
          prerelease: false
